<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LLM Model Registry</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- Top Nav -->
  <header class="nav">
    <div class="container nav__inner">
      <div class="brand">LLM Model Registry</div>
      <nav class="nav__right">
        <input id="apiBase" class="input input--sm" placeholder="https://api.example.com" />
        <button id="saveApi" class="btn btn--ghost">Save API</button>
        <select id="task" class="input input--sm">
          <option value="home">Home</option>
          <option value="health">System Health</option>
          <option value="models">Models</option>
          <option value="upload">Upload</option>
        </select>
        <button id="goBtn" class="btn btn--primary">Open</button>
      </nav>
    </div>
  </header>

  <main class="container page">
    <!-- HOME (new) -->
    <section id="view-home" class="card">
      <div class="hero">
        <div class="hero__text">
          <h1>Ship a trustworthy model catalog</h1>
          <p class="muted">
            Upload, search, rate, and download models. See live health for the last hour, and keep artifacts safe in S3.
          </p>
          <div class="hero__actions">
            <button class="btn btn--primary" data-goto="upload">Upload a Model</button>
            <button class="btn" data-goto="models">Browse Models</button>
            <button class="btn btn--ghost" data-goto="health">View System Health</button>
          </div>
        </div>
        <div class="hero__panel">
          <div class="stat">
            <div class="stat__label">Models</div>
            <div class="stat__value" id="home-models">—</div>
          </div>
          <div class="stat">
            <div class="stat__label">Downloads (1h)</div>
            <div class="stat__value" id="home-dls">—</div>
          </div>
          <div class="stat">
            <div class="stat__label">p95 Latency</div>
            <div class="stat__value" id="home-lat">—</div>
          </div>
          <div class="status">
            <span class="status__dot" id="home-status-dot"></span>
            <span id="home-status-text">Checking…</span>
          </div>
        </div>
      </div>

      <div class="features">
        <div class="feature">
          <h3>Search & Filters</h3>
          <p class="muted">Regex by name and semantic version ranges. Paginated so big catalogs don’t crash the page.</p>
        </div>
        <div class="feature">
          <h3>Trust Signals</h3>
          <p class="muted">Reproducibility, Reviewedness, and Treescore to judge model quality at a glance.</p>
        </div>
        <div class="feature">
          <h3>Partial Downloads</h3>
          <p class="muted">Grab just the weights, dataset, or docs via presigned links to save time and bandwidth.</p>
        </div>
      </div>

      <div class="home-list">
        <div class="home-list__header">
          <h3>Recent Models</h3>
          <button class="btn btn--ghost" data-goto="models">See all</button>
        </div>
        <div id="home-model-list" class="list">Loading…</div>
      </div>
    </section>

    <!-- HEALTH -->
    <section id="view-health" class="card hidden">
      <h2>System Health (last hour)</h2>
      <div class="metrics">
        <div class="metric"><div class="metric__label">Requests</div><div id="h-req" class="metric__value">—</div></div>
        <div class="metric"><div class="metric__label">Error rate</div><div id="h-err" class="metric__value">—</div></div>
        <div class="metric"><div class="metric__label">p95 latency</div><div id="h-lat" class="metric__value">—</div></div>
        <div class="metric"><div class="metric__label">Status</div><div id="healthBadge" class="badge">loading…</div></div>
      </div>
      <div class="bar">
        <button id="refreshHealth" class="btn">Refresh</button>
        <span class="muted" id="healthUpdated">Updated: —</span>
      </div>
    </section>

    <!-- MODELS -->
    <section id="view-models" class="card hidden">
      <h2>Models</h2>
      <div class="bar">
        <input id="q" class="input" placeholder="Search name or regex…" />
        <input id="ver" class="input" placeholder="Version (^1.2, ~2.0, 1.3.0)" />
        <button id="searchBtn" class="btn btn--primary">Search</button>
      </div>
      <div class="table">
        <table>
          <thead><tr><th>Name</th><th>Version</th><th>Scores</th><th>Size</th><th></th></tr></thead>
          <tbody id="modelsTbody"><tr><td colspan="5" class="muted">No results yet.</td></tr></tbody>
        </table>
      </div>
      <div class="pager">
        <button id="prevPage" class="btn">Prev</button>
        <span class="muted" id="pageInfo">Page 1</span>
        <button id="nextPage" class="btn">Next</button>
      </div>

      <div id="detail" class="detail hidden">
        <h3 id="d-title">Model Details</h3>
        <div class="muted" id="d-meta">—</div>
        <div class="badges">
          <span class="badge" id="d-license">—</span>
          <span class="badge" id="d-licenseStatus">—</span>
        </div>
        <div class="panel"><div class="panel__title">Trust scores</div><div id="d-scores">—</div></div>
        <div class="panel">
          <div class="panel__title">Partial download</div>
          <div class="row">
            <label><input type="checkbox" class="part" value="weights" checked> Weights</label>
            <label><input type="checkbox" class="part" value="dataset"> Dataset</label>
            <label><input type="checkbox" class="part" value="docs"> Docs</label>
            <button id="downloadBtn" class="btn btn--success">Download</button>
            <span class="muted" id="dlMsg">—</span>
          </div>
        </div>
        <div class="panel"><div class="panel__title">Lineage</div><div id="d-lineage">—</div></div>
      </div>
    </section>

    <!-- UPLOAD -->
    <section id="view-upload" class="card hidden">
      <h2>Upload / Register Model</h2>
      <form id="uploadForm" class="form">
        <label>Name <input name="name" required class="input" /></label>
        <label>Version <input name="version" required placeholder="1.0.0" class="input" /></label>
        <label>License <input name="license" required placeholder="Apache-2.0" class="input" /></label>
        <label class="file">
          <input type="file" id="file" accept=".zip" required />
          <span>Choose .zip</span>
        </label>
        <div class="row">
          <button class="btn btn--primary" type="submit">Upload</button>
          <span class="muted" id="uploadMsg">Choose a .zip and submit</span>
        </div>
      </form>
    </section>
  </main>

  <footer class="footer">
    <div class="container muted">© <span id="year"></span> LLM Model Registry • Built for Phase 2</div>
  </footer>

  <script>
    // Basic wiring (same backend expectations as before)
    const $ = (q)=>document.querySelector(q);
    const apiBaseInput = $('#apiBase');
    const saved = localStorage.getItem('apiBase') || '';
    if (saved) apiBaseInput.value = saved;
    $('#saveApi').onclick = ()=>{ localStorage.setItem('apiBase', apiBaseInput.value.trim()); alert('Saved API base.'); };
    const API = () => {
      const manual = apiBaseInput.value.trim();
      if (manual) return manual.replace(/\/+$/, '');

      // Fallback: use same host, port 8080 for backend
      const loc = window.location;
      return `${loc.protocol}//${loc.hostname}:8080`;
    };

    const views = { home:$('#view-home'), health:$('#view-health'), models:$('#view-models'), upload:$('#view-upload') };
    function show(id){ Object.values(views).forEach(v=>v.classList.add('hidden')); views[id].classList.remove('hidden'); if(id==='home') loadHome(); if(id==='health') loadHealth(); if(id==='models') loadModels(); }
    $('#goBtn').onclick = ()=> show($('#task').value);
    document.querySelectorAll('[data-goto]').forEach(b=> b.onclick = ()=> show(b.dataset.goto));
    show('home'); $('#year').textContent = new Date().getFullYear();

    async function loadHome(){
      // pull small summaries from /health and /models
      try {
        const [hr, mr] = await Promise.all([
          fetch(`${API()}/health`).then(r=>r.json()),
          fetch(`${API()}/models?page=1&page_size=5`).then(r=>r.json())
        ]);
        $('#home-status-text').textContent = (hr.status || 'unknown');
        $('#home-status-dot').className = 'status__dot ' + ((hr.status||'').toLowerCase()==='ok' ? 'ok' : 'bad');
        $('#home-dls').textContent = hr.downloads_1h ?? '—';
        $('#home-lat').textContent = (hr.p95_ms!=null ? (hr.p95_ms+' ms') : '—');

        const items = (mr.items || []);
        $('#home-models').textContent = mr.total ?? items.length;
        const list = items.map(m => `
          <div class="list__item">
            <div><strong>${m.name}</strong> <span class="muted">v${m.version}</span></div>
            <div class="muted small">Size: ${formatSize(m.size_bytes)} • Repr ${m.scores?.reproducibility ?? '-'} • Rev ${m.scores?.reviewedness ?? '-'} • Tree ${m.scores?.treescore ?? '-'}</div>
          </div>`).join('') || '<div class="muted">No recent models.</div>';
        $('#home-model-list').innerHTML = list;
      } catch { /* swallow */ }
    }

    // Health (same as earlier, simplified visuals)
    async function loadHealth(){
      const badge = $('#healthBadge'), req=$('#h-req'), err=$('#h-err'), lat=$('#h-lat'), upd=$('#healthUpdated');
      badge.textContent='loading…'; badge.className='badge';
      try{
        const j = await fetch(`${API()}/health`).then(r=>r.json());
        const ok=(j.status||'').toLowerCase()==='ok';
        badge.textContent=j.status||'unknown'; badge.className='badge ' + (ok?'badge--ok':'badge--bad');
        req.textContent=j.requests_1h ?? '—';
        err.textContent=j.error_rate ?? '—';
        lat.textContent=(j.p95_ms!=null ? (j.p95_ms+' ms') : '—');
        upd.textContent='Updated: '+new Date().toLocaleTimeString();
      }catch{ badge.textContent='unreachable'; badge.className='badge badge--bad'; req.textContent=err.textContent=lat.textContent='—'; upd.textContent='Updated: (failed)';}
    }
    $('#refreshHealth').onclick = loadHealth;

    // Models list (same API contract)
    let page=1; const tbody=$('#modelsTbody'), pageInfo=$('#pageInfo');
    function formatSize(bytes){ if(bytes==null) return '—'; const u=['B','KB','MB','GB','TB']; let i=0,n=bytes; while(n>=1024&&i<u.length-1){n/=1024;i++;} return n.toFixed(1)+' '+u[i]; }
    async function loadModels(){
      tbody.innerHTML = `<tr><td colspan="5" class="muted">Loading…</td></tr>`;
      const q=$('#q').value.trim(), ver=$('#ver').value.trim();
      const url=new URL(`${API()}/models`); if(q) url.searchParams.set('query',q); if(ver) url.searchParams.set('version',ver); url.searchParams.set('page',page); url.searchParams.set('page_size',20);
      try{
        const j=await fetch(url).then(r=>r.json()); const items=j.items||[];
        if(!items.length){ tbody.innerHTML=`<tr><td colspan="5" class="muted">No results.</td></tr>`; }
        else {
          tbody.innerHTML=''; for(const m of items){
            const tr=document.createElement('tr');
            tr.innerHTML = `
              <td>${m.name}</td>
              <td>${m.version}</td>
              <td><span class="tag">Repr: ${m.scores?.reproducibility ?? '-'}</span>
                  <span class="tag">Rev: ${m.scores?.reviewedness ?? '-'}</span>
                  <span class="tag">Tree: ${m.scores?.treescore ?? '-'}</span></td>
              <td>${formatSize(m.size_bytes)}</td>
              <td><button class="btn btn--ghost" data-id="${m.id}">View</button></td>`;
            tbody.appendChild(tr);
          }
          [...document.querySelectorAll('[data-id]')].forEach(b=> b.onclick=()=> loadDetail(b.dataset.id));
        }
        pageInfo.textContent=`Page ${j.page||page} of ${j.total_pages||'—'}`;
      }catch{ tbody.innerHTML=`<tr><td colspan="5" class="muted">Failed to load models.</td></tr>`; }
    }
    $('#searchBtn').onclick = ()=>{ page=1; loadModels(); };
    $('#prevPage').onclick = ()=>{ if(page>1){ page--; loadModels(); } };
    $('#nextPage').onclick = ()=>{ page++; loadModels(); };

    // Detail + download
    async function loadDetail(id){
      $('.detail').classList.remove('hidden');
      $('#d-title').textContent='Loading…'; $('#d-meta').textContent=''; $('#d-scores').textContent='—'; $('#d-license').textContent='—'; $('#d-licenseStatus').textContent='—'; $('#d-lineage').textContent='—'; $('#dlMsg').textContent='—';
      try{
        const m=await fetch(`${API()}/models/${encodeURIComponent(id)}`).then(r=>r.json());
        $('#d-title').textContent=`${m.name} — v${m.version}`;
        $('#d-meta').textContent=`Uploader: ${m.uploader ?? '—'} • Created: ${m.created_at ?? '—'} • Size: ${formatSize(m.size_bytes)}`;
        $('#d-scores').textContent=`Repr: ${m.scores?.reproducibility ?? '-'} | Reviewed: ${m.scores?.reviewedness ?? '-'} | Treescore: ${m.scores?.treescore ?? '-'}`;
        $('#d-license').textContent=m.license ?? '—'; $('#d-licenseStatus').textContent=m.license_status ?? 'unknown';
        $('#d-lineage').textContent=(m.parents?.length ? `Parents: ${m.parents.join(', ')}` : 'No lineage data');
        document.getElementById('downloadBtn').onclick = async ()=>{
          $('#dlMsg').textContent='Preparing…'; const parts=[...document.querySelectorAll('.part:checked')].map(c=>c.value);
          try{
            const r=await fetch(`${API()}/models/${encodeURIComponent(id)}/download`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({parts}) });
            if(!r.ok) throw new Error(); const j=await r.json(); if(!j.url) throw new Error(); window.location.href=j.url; $('#dlMsg').textContent='Download started.';
          }catch{ $('#dlMsg').textContent='Download failed. Try again.'; }
        };
        document.querySelector('.detail').scrollIntoView({behavior:'smooth'});
      }catch{ $('#d-title').textContent='Failed to load model.'; }
    }

    // Upload
    $('#uploadForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); const msg=$('#uploadMsg'); const f=document.getElementById('file').files[0]; if(!f){msg.textContent='Please select a .zip file.'; return;}
      msg.textContent='Uploading…';
      try{
        const data=new FormData(); data.append('file', f); data.append('name', e.target.elements.name.value); data.append('version', e.target.elements.version.value); data.append('license', e.target.elements.license.value);
        const r=await fetch(`${API()}/upload`,{method:'POST', body:data}); if(!r.ok) throw new Error(); const j=await r.json();
        msg.textContent='Upload complete.'; show('models'); loadModels(); setTimeout(()=> j.id && loadDetail(j.id), 400);
      }catch{ msg.textContent='Upload failed. Check file size and server logs.'; }
    });
  </script>
</body>
</html>
